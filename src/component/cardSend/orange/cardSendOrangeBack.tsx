import React, {Component} from 'react';
import ReactGA from "react-ga4";

import '../../../static/cardSend/cardSendBack.css';
import * as service from '../../../service/service'

import { Card } from '../white/cardSendWhiteFrame'
import { cardSendFrontProps } from '../white/cardSendWhiteBack';
import ChooseTagFirst from './chooseTag/chooseTag1';
import ChooseTagSecond from './chooseTag/chooseTag2'
import ChooseTagThird from './chooseTag/chooseTag3'
import ChooseTagFourth from './chooseTag/chooseTag4'

import CardCompleteOrange from './cardSendOrangeComplete'
import CardSendOrangeFront from './cardSendOrangeFront'

interface Tag{
    FirstTag : chooseTag1
}

interface chooseTag1 {
    FirstTag : any,
}

interface chooseTag2 {
    SecondTag : any
}

interface chooseTag3 {
    ThirdTag : any
}

interface chooseTag4 {
    FourthTag : any
}

class CardSendOrangeBack extends React.Component<cardSendFrontProps, any> {
    constructor(props: any){
        super(props)

        this.state = {
            card: {} as Card,
            chooseFirstTag : false,
            chooseSecondTag : false,
            chooseThirdTag : false,
            chooseFourthTag : false,
            firstTag : "",
            secondTag : "",
            thirdTag : "",
            fourthTag : "",
            memo: "",
            isCompleted: false,
            showFront: false,
        }

        this.chooseTagFirst = this.chooseTagFirst.bind(this)
        this.chooseTagSecond = this.chooseTagSecond.bind(this)
        this.chooseTagThird = this.chooseTagThird.bind(this)
        this.chooseTagFourth = this.chooseTagFourth.bind(this)
        this.clickFirst = this.clickFirst.bind(this)
        this.clickSecond = this.clickSecond.bind(this)
        this.clickThird = this.clickThird.bind(this)
        this.clickFourth = this.clickFourth.bind(this)
        this.writeMemo = this.writeMemo.bind(this)
        this.backButton = this.backButton.bind(this)
    }

    componentDidMount(): void {
        const numOfTags = Object.keys(this.props.card).length

        if(numOfTags !== 0) {
            this.setState({
                firstTag: this.props.card.firstTag,
                secondTag: this.props.card.secondTag,
                thirdTag: this.props.card.thirdTag,
                fourthTag: this.props.card.fourthTag,
                memo: this.props.card.memo,
                card: {
                    fromPerson: this.props.card.fromPerson,
                    toPerson: this.props.card.toPerson,
                    firstTag: this.props.card.firstTag,
                    secondTag: this.props.card.secondTag,
                    thirdTag: this.props.card.thirdTag,
                    fourthTag: this.props.card.fourthTag,
                    memo: this.props.card.memo,
                }
            })
        }
    }
    backButton(){
        // location.hrefÎ°ú ÌïòÎ©¥ ÏÉàÎ°úÍ≥†Ïπ® ÎêòÏñ¥ÏÑú Ïù¥Ï†ÑÏóê ÏûëÏÑ±ÌñàÎçò ÎÇ¥Ïö©Îì§Ïù¥ ÏÇ¨ÎùºÏßê..
        // Îí∑Ïû• Ïì∞Í∏∞ ÌñàÎçò Í≤É Ï≤òÎüº Ïª¥Ìè¨ÎÑåÌä∏Î•º Î≥ÄÍ≤ΩÌïòÎäî Î∞©Î≤ï ÏÉùÍ∞ÅÌï¥Î≥¥Í∏∞
        //window.location.href = '/cardsend/white'

        this.setState({
            showFront: true,
            card: {
                fromPerson: this.props.card.fromPerson,
                toPerson: this.props.card.toPerson,
                firstTag: this.state.firstTag,
                secondTag: this.state.secondTag,
                thirdTag: this.state.thirdTag,
                fourthTag: this.state.fourthTag,
                memo: this.state.memo,
            }
        })    
    }

    // Ï≤´Î≤àÏß∏ ÌÉúÍ∑∏ ÏÑ†ÌÉùÌïòÎäî ÌôîÎ©¥
    chooseTagFirst(){
        this.setState({
            chooseFirstTag: true
        })
    }

    // ÎëêÎ≤àÏß∏ ÌÉúÍ∑∏ ÏÑ†ÌÉùÌïòÎäî ÌôîÎ©¥
    chooseTagSecond(){
        this.setState({
            chooseSecondTag: true
        })
    }

    // ÏÑ∏Î≤àÏß∏ ÌÉúÍ∑∏ ÏÑ†ÌÉùÌïòÎäî ÌôîÎ©¥
    chooseTagThird(){
        this.setState({
            chooseThirdTag: true
        })
    }

    // ÎÑ§Î≤àÏß∏ ÌÉúÍ∑∏ ÏÑ†ÌÉùÌïòÎäî ÌôîÎ©¥
    chooseTagFourth(){
        this.setState({
            chooseFourthTag: true
        })
    }

    // Ï≤´Î≤àÏß∏ ÌÉúÍ∑∏ ÏÑ†ÌÉù ÏôÑÎ£å
    clickFirst = (data: any) => {
        this.setState({
            firstTag : data,
            chooseFirstTag : false
        })
    }

    // ÎëêÎ≤àÏß∏ ÌÉúÍ∑∏ ÏÑ†ÌÉù ÏôÑÎ£å
    clickSecond = (data: any) => {
        this.setState({
            secondTag : data,
            chooseSecondTag : false
        })
    }

    // ÏÑ∏Î≤àÏß∏ ÌÉúÍ∑∏ ÏÑ†ÌÉù ÏôÑÎ£å
    clickThird = (data: any) => {
        this.setState({
            thirdTag : data,
            chooseThirdTag : false
        })
    }

    // ÎÑ§Î≤àÏß∏ ÌÉúÍ∑∏ ÏÑ†ÌÉù ÏôÑÎ£å
    clickFourth = (data: any) => {
        this.setState({
            fourthTag : data,
            chooseFourthTag : false
        })
    }

    writeMemo = (data: any) => {
        data.target.value = this.limitString(data.target.value)

        this.setState({
            memo : data.target.value
        })
    }
    
    limitString = (string: string) => {
        const limit = 100
        string.length > limit ? string = string.substring(0, limit) : string = string

        return string
    }

    removeEmoji = (event: any) => {
        let string = event.target.value

        if(this.doesStrContainEmoji(string)) {
            const regexExp =  /(?:[\u2700-\u27bf]|(?:\ud83c[\udde6-\uddff]){2}|[\ud800-\udbff][\udc00-\udfff]|[\u0023-\u0039]\ufe0f?\u20e3|\u3299|\u3297|\u303d|\u3030|\u24c2|\ud83c[\udd70-\udd71]|\ud83c[\udd7e-\udd7f]|\ud83c\udd8e|\ud83c[\udd91-\udd9a]|\ud83c[\udde6-\uddff]|\ud83c[\ude01-\ude02]|\ud83c\ude1a|\ud83c\ude2f|\ud83c[\ude32-\ude3a]|\ud83c[\ude50-\ude51]|\u203c|\u2049|[\u25aa-\u25ab]|\u25b6|\u25c0|[\u25fb-\u25fe]|\u00a9|\u00ae|\u2122|\u2139|\ud83c\udc04|[\u2600-\u26FF]|\u2b05|\u2b06|\u2b07|\u2b1b|\u2b1c|\u2b50|\u2b55|\u231a|\u231b|\u2328|\u23cf|[\u23e9-\u23f3]|[\u23f8-\u23fa]|\ud83c\udccf|\u2934|\u2935|[\u2190-\u21ff]|\ufe0f|\u2764|\u200d)/g

            alert('Ïù¥Î™®Ìã∞ÏΩò ÏÇ¨Ïö©ÏùÄ Î∂àÍ∞ÄÌï¥Ïöîüò¢')

            event.target.value = string.replace(regexExp, '')
            
            this.setState({
                memo : event.target.value
            })
        }  
    }

    doesStrContainEmoji = (string: string) => {
        const regexExp =  /(?:[\u2700-\u27bf]|(?:\ud83c[\udde6-\uddff]){2}|[\ud800-\udbff][\udc00-\udfff]|[\u0023-\u0039]\ufe0f?\u20e3|\u3299|\u3297|\u303d|\u3030|\u24c2|\ud83c[\udd70-\udd71]|\ud83c[\udd7e-\udd7f]|\ud83c\udd8e|\ud83c[\udd91-\udd9a]|\ud83c[\udde6-\uddff]|\ud83c[\ude01-\ude02]|\ud83c\ude1a|\ud83c\ude2f|\ud83c[\ude32-\ude3a]|\ud83c[\ude50-\ude51]|\u203c|\u2049|[\u25aa-\u25ab]|\u25b6|\u25c0|[\u25fb-\u25fe]|\u00a9|\u00ae|\u2122|\u2139|\ud83c\udc04|[\u2600-\u26FF]|\u2b05|\u2b06|\u2b07|\u2b1b|\u2b1c|\u2b50|\u2b55|\u231a|\u231b|\u2328|\u23cf|[\u23e9-\u23f3]|[\u23f8-\u23fa]|\ud83c\udccf|\u2934|\u2935|[\u2190-\u21ff]|\ufe0f|\u2764|\u200d)/g

        return regexExp.test(string)
    }

    completeCard = async(e: any) => {
        if (!this.state.firstTag) {
            alert("Ï≤´Î≤àÏß∏ ÌÉúÍ∑∏Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.")
        } else if (!this.state.secondTag) {
            alert("ÎëêÎ≤àÏß∏ ÌÉúÍ∑∏Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.")
        } else if (!this.state.thirdTag) {
            alert("ÏÑ∏Î≤àÏß∏ ÌÉúÍ∑∏Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.")
        } else if (!this.state.fourthTag) {
            alert("ÎÑ§Î≤àÏß∏ ÌÉúÍ∑∏Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.")
        } else {
            ReactGA.event({
                category: "Button",
                action: "complete_card",
                label: "cardSend",
            });
            
            const memoByDefault = "ÏÉùÏùºÏóêÎÇò Ìï† Ïàò ÏûàÎäî ÏñòÍ∏∞Î•º Ïò§Îäò Ìï¥Î≥¥ÎÑ§!\nÎÇØÍ∞ÑÏßÄÎüΩÏßÄÎßå Íº≠ Ìï¥Ï£ºÍ≥† Ïã∂ÏùÄ ÎßêÏù¥Ïïº.\nÎß§ÏùºÏù¥ ÏÉùÏùºÏ≤òÎüº ÌäπÎ≥ÑÌñàÏúºÎ©¥ Ï¢ãÍ≤†Ïñ¥.\nÏò§ÎäòÎèÑ Ìï¥Ìîº Ïñ∏Î≤ÑÏä§Îç∞Ïù¥ :)";
            
            this.setState({
                isCompleted: true,
                card: {
                    toPerson: this.props.card.toPerson,
                    fromPerson: this.props.card.fromPerson,
                    firstTag: this.state.firstTag,
                    secondTag: this.state.secondTag,
                    thirdTag: this.state.thirdTag,
                    fourthTag: this.state.fourthTag,
                    memo: this.state.memo ? this.state.memo : memoByDefault,
                }
            })
        }
    }

    handleCompleteCard = (response: any) => {
        var cardUUID = response.data.data
        sessionStorage.setItem("cardUUID", cardUUID)
        window.location.href = '/cardsend/orange/' + cardUUID
    }

    isCompleted = () => {
        this.setState({isCompleted: !this.state.isCompleted})
    }

    render() {
        if(this.state.showFront) {
            return <CardSendOrangeFront card={this.state.card} />
        }
        else if(this.state.isCompleted) {
            return <CardCompleteOrange card={this.state.card} fixCard={this.isCompleted}/>
        }
        return(
            <div className= 'CS1main'>
                <div className="CS3btn">
                    <img src="../img/back.png" className="CS3backBtn" onClick={this.backButton}/>
                </div>
                <div className='CS3mainText'>
                    Í∑∏ ÏÇ¨ÎûåÏùÑ ÏÉùÍ∞ÅÌïòÎ©∞ Ï±ÑÏõåÏ£ºÏÑ∏Ïöî.
                </div>
                <div className="CS3yelloBox">
                    <div>
                        <img className="CS3card" src="../img/orangeBack.png"/>
                    </div>
                        
                    <div className="CS3insideYellow">
                        <div className='CS3personNameforOrange'>
                            HAPPY<br></br>
                            UN-BIRTHDAY {this.props.card.toPerson}!
                        </div>
                        <div className="CS3tagMessage">
                            <div className="CS3temp">
                                <div className="CS3tagSpace">
                                    <span className="CS3tag-orange">
                                        <div onClick={this.chooseTagFirst}>{this.state.firstTag ? this.state.firstTag : "#ÌÉúÍ∑∏ÏÑ†ÌÉù"}</div>
                                        {this.state.chooseFirstTag ? <ChooseTagFirst clickFirst = {this.clickFirst}/>:''}
                                    </span>
                                 </div>
                                <div className="CS3textSpace">
                                    <div className='CS3subText'>
                                        {this.props.card.toPerson}(Ïù¥)Îäî
                                    </div>
                                </div>
                            </div>
                                
                            <div className="CS3temp">
                                 <div className="CS3textSpace">
                                    <div className='CS3subText'>
                                        Ï†ïÎßê 
                                    </div>
                                </div>
                    
                                <div className="CS3tagSpace">
                                    <span className="CS3tag-orange">
                                        <div onClick={this.chooseTagSecond}>{this.state.secondTag ? this.state.secondTag : "#ÌÉúÍ∑∏ÏÑ†ÌÉù"}</div>
                                        {this.state.chooseSecondTag ? <ChooseTagSecond clickSecond = {this.clickSecond}/>:''}
                                        </span>
                                    </div>
                                    
                                    <div className="CS3textSpace">
                                        <div className='CS3subText'>ÏÇ¨ÎûåÏù¥Ïïº.</div>
                                    </div>
                                </div>
            
                                <div className="CS3temp">
                                    <div className="CS3textSpace">
                                        <div className='CS3subText'>ÎÇòÎäî</div>
                                    </div>
                                    
                                    <div className="CS3textSpace">
                                        <div className='CS3subText'>{this.props.card.toPerson}(Ïù¥)Ïùò</div>
                                    </div>
                                    
                                    <div className="CS3tagSpace">
                                        <span className="CS3tag-orange">
                                            <div onClick={this.chooseTagThird}>{this.state.thirdTag ? this.state.thirdTag : "#ÌÉúÍ∑∏ÏÑ†ÌÉù"}</div>
                                            {this.state.chooseThirdTag ? <ChooseTagThird clickThird = {this.clickThird}/>:''}
                                        </span>
                                    </div>
                                </div>
            
                                <div className="CS3temp">
                                    <div className="CS3tagSpace">
                                        <span className="CS3tag-orange">
                                            <div onClick={this.chooseTagFourth}>{this.state.fourthTag ? this.state.fourthTag : "#ÌÉúÍ∑∏ÏÑ†ÌÉù"}</div>
                                            {this.state.chooseFourthTag ? <ChooseTagFourth clickFourth = {this.clickFourth}/>:''}
                                        </span>
                                    </div>
                                    <div className="CS3textSpace">
                                        <div className='CS3subText'>
                                        Î™®ÏäµÏù¥ Ï¢ãÏïÑ.</div>
                                    </div>
                                </div>
    
                            </div> 
                        
                        
                            <div className="CS3writeMessage">
                                {!this.state.memo ?
                                    <textarea className="memo" cols={10} rows={5} onChange={this.writeMemo} onBlur={this.removeEmoji} placeholder={"ÏÉùÏùºÏóêÎÇò Ìï† Ïàò ÏûàÎäî ÏñòÍ∏∞Î•º Ïò§Îäò Ìï¥Î≥¥ÎÑ§!\nÎÇØÍ∞ÑÏßÄÎüΩÏßÄÎßå Íº≠ Ìï¥Ï£ºÍ≥† Ïã∂ÏùÄ ÎßêÏù¥Ïïº.\nÎß§ÏùºÏù¥ ÏÉùÏùºÏ≤òÎüº ÌäπÎ≥ÑÌñàÏúºÎ©¥ Ï¢ãÍ≤†Ïñ¥.\nÏò§ÎäòÎèÑ Ìï¥Ìîº Ïñ∏Î≤ÑÏä§Îç∞Ïù¥ :) "} />
                                    : <textarea className="memo" cols={10} rows={5} onChange={this.writeMemo} onBlur={this.removeEmoji} value={this.state.memo}/>
                                }
                                <div className="CS3numCnt">{this.state.memo ? this.state.memo.length : '0'}/100</div>
                                <div className="CS3notice">ÏûÖÎ†•ÏùÑ Ïïà Ìï† Í≤ΩÏö∞ ÏòàÏãú Î¨∏Íµ¨Î°ú Ïπ¥ÎìúÎ•º ÏôÑÏÑ±Ìï¥ÎìúÎ†§Ïöî.</div>
                            </div>
    
                        </div>
                    </div>
                    
                    <div className='CS3complete'>
                        <img src="../../img/bt_complete.png" onClick={this.completeCard}/>
                        {/* ÏôÑÏÑ±ÌïòÍ∏∞ ÎàÑÎ•¥Î©¥ uuid ÏÉùÏÑ±ÌïòÍ≥† Í∑∏ urlÎ°ú Ïù¥ÎèôÏãúÌÇ® Îã§ÏùåÏóê Complete Î≥¥Ïó¨Ï£ºÍ∏∞ */}
                    </div>
                </div>
   
        )
    }
}
export default CardSendOrangeBack;